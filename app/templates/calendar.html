{% extends 'base.html' %}

{% block title %}Events Calendar{% endblock %}

{% block content %}
  <h2 class="page-heading">Events Calendar - {{ month_name }}</h2>
  <div class="calendar-controls">
    <input type="month" id="monthPicker" value="{{ '%04d-%02d'|format(year, month) }}">
  </div>
  <table class="calendar" id="calendarTable">
    <thead>
      <tr>
        <th>Sun</th>
        <th>Mon</th>
        <th>Tue</th>
        <th>Wed</th>
        <th>Thu</th>
        <th>Fri</th>
        <th>Sat</th>
      </tr>
    </thead>
    <tbody id="calendarBody">
    </tbody>
  </table>
  {% if session.role == 'admin' %}
  <h3>Events This Month</h3>
  <ul>
    {% for ev in events %}
      <li>
        <span style="background-color: {{ ev.color }}; padding: 2px 6px;">{{ ev.title }} ({{ ev.start_date }} - {{ ev.end_date }})</span>
        <a href="{{ url_for('admin.delete_event', event_id=ev.id) }}" onclick="return confirm('Delete this event?');">Delete</a>
      </li>
    {% else %}
      <li>No events</li>
    {% endfor %}
  </ul>
  {% endif %}

  <script>
    const events = {{ events|tojson }};
    const month = {{ month }};
    const year = {{ year }};
    const monthPicker = document.getElementById('monthPicker');

    function parseUTC(dateStr) {
      const [y, m, d] = dateStr.split('-').map(Number);
      return new Date(Date.UTC(y, m - 1, d));
    }

    function formatUTC(dateObj) {
      return dateObj.toISOString().slice(0, 10);
    }

    function getEventsMap() {
      const map = {};
      events.forEach(ev => {
        const start = parseUTC(ev.start_date);
        const end = parseUTC(ev.end_date);
        for (let d = new Date(start); d <= end; d.setUTCDate(d.getUTCDate() + 1)) {
          const key = formatUTC(d);
          if (!map[key]) map[key] = [];
          map[key].push(ev);
        }
      });
      return map;
    }

    function renderCalendar(m, y) {
      const firstDay = new Date(Date.UTC(y, m-1, 1));
      const lastDay = new Date(Date.UTC(y, m, 0)).getUTCDate();
      const startDay = firstDay.getUTCDay();
      const body = document.getElementById('calendarBody');
      const eventsMap = getEventsMap();
      body.innerHTML = '';
      let row = document.createElement('tr');
      for (let i=0;i<startDay;i++) {
        row.appendChild(document.createElement('td'));
      }
      for (let date=1; date<=lastDay; date++) {
        if (row.children.length === 7) {
          body.appendChild(row);
          row = document.createElement('tr');
        }
        const cell = document.createElement('td');
        const cellDate = new Date(Date.UTC(y, m-1, date));
        const key = formatUTC(cellDate);
        cell.innerHTML = `<div class="day-number">${date}</div>`;
        if (eventsMap[key]) {
          const ev = eventsMap[key][0];
          cell.style.backgroundColor = ev.color;
          cell.title = eventsMap[key].map(e=>e.title).join('\n');
        }
        row.appendChild(cell);
      }
      if (row.children.length) {
        while (row.children.length < 7) row.appendChild(document.createElement('td'));
        body.appendChild(row);
      }
    }
    monthPicker.addEventListener('change', () => {
      const [y, m] = monthPicker.value.split('-');
      const params = new URLSearchParams(window.location.search);
      params.set('month', parseInt(m));
      params.set('year', parseInt(y));

      window.location.search = params.toString();
    });

    renderCalendar(month, year);
  </script>
{% endblock %}
